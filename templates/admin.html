<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>injury reserves - admin</title>
  <div>
  <div class="hint">our score (auto)</div>
  <input id="teamScore" value="0" disabled />
</div>
<div>
  <div class="hint">opp score</div>
  <input id="oppScore" value="0" />
</div>

  <style>
    body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 20px auto; padding: 0 12px; }
    .top { display:flex; gap:12px; flex-wrap: wrap; align-items:end; }
    input, select, button { padding: 10px; font-size: 14px; }
    button { cursor: pointer; }
    .hint { color:#666; font-size: 13px; }
    .small { font-size: 12px; color:#555; margin-top: 8px; }

    .table { margin-top: 14px; border:1px solid #ddd; border-radius: 14px; overflow: hidden; }
    .thead, .trow {
      display: grid;
      grid-template-columns:
        220px  /* name */
        repeat(13, 72px) /* editable stats */
        80px; /* remove */
      gap: 0;
      align-items: center;
    }
    .thead { background: #fafafa; border-bottom: 1px solid #eee; }
    .th, .td { padding: 10px 8px; border-right: 1px solid #eee; }
    .thead .th:last-child, .trow .td:last-child { border-right: none; }

    .trow { border-bottom: 1px solid #eee; }
    .trow:last-child { border-bottom: none; }

    .statbox {
      border: 1px solid #e2e2e2;
      border-radius: 12px;
      padding: 8px 8px;
      user-select: none;
      cursor: pointer;
      text-align: center;
      background: white;
    }
    .statlabel { font-size: 10px; color:#666; margin-bottom: 2px; }
    .statval { font-size: 18px; font-weight: 700; line-height: 1.1; }
    .namecell { font-weight: 700; }
    .msg { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background:#f6f6f6; border:1px solid #e5e5e5; display:none; }
    .danger { border-color: #ffb3b3; }

    @media (max-width: 1100px) {
      body { max-width: 100%; }
      .thead, .trow { overflow-x: auto; }
      .table { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <h2>admin game entry</h2>

  <div class="top">
    <div>
      <div class="hint">season</div>
      <input id="season" value="4" />
    </div>
    <div>
      <div class="hint">game</div>
      <input id="game" value="1" />
    </div>
    <div style="min-width: 220px;">
      <div class="hint">opp</div>
      <input id="opp" placeholder="OPP" />
    </div>
    <div>
      <div class="hint">type</div>
      <select id="type">
        <option value="REG">REG</option>
        <option value="PRE">PRE</option>
        <option value="FINAL">FINAL</option>
      </select>
    </div>

    <div style="min-width: 260px;">
      <div class="hint">add player</div>
      <select id="playerSelect" style="min-width: 260px;">
        <option value="">select player...</option>
      </select>
    </div>

    <div style="min-width: 220px;">
      <div class="hint">or custom name</div>
      <input id="customName" placeholder="new player name" />
    </div>

    <button id="addPlayer">add</button>
    <button id="save">save game</button>
  </div>

  <div class="small">
    double click a stat to +1. shift + double click to -1. derived stats (%/gsc/fgm/fga/pts/reb) still auto-calc on save.
  </div>

  <div id="msg" class="msg"></div>

  <div class="table" id="table">
    <div class="thead" id="thead"></div>
    <div id="tbody"></div>
  </div>

<script>
  const API = "http://127.0.0.1:5001";

  const COMMON_PLAYERS = [
    "Daniel Monitto",
    "Lachlan Farley",
    "James Norrish",
    "Vince Tomasello",
    "Austin Thorneycroft",
    "Brooklyn Bulmer"
  ];

  const EDITABLE = [
    ["2PM","2pm"], ["2PA","2pa"], ["3PM","3pm"], ["3PA","3pa"],
    ["FTM","ftm"], ["FTA","fta"],
    ["OREB","oreb"], ["DREB","dreb"],
    ["AST","ast"], ["STL","stl"], ["BLK","blk"],
    ["TOV","tov"], ["FLS","fls"]
  ];

  const clamp0 = (n) => Math.max(0, n|0);

  function pct(m, a) { return a ? (m / a) : 0; }

  function calcGSC(p) {
    const PTS = p.PTS, FG = p.FGM, FGA = p.FGA, FT = p.FTM, FTA = p.FTA;
    const ORB = p.OREB, DRB = p.DREB, STL = p.STL, AST = p.AST, BLK = p.BLK;
    const PF = p.FLS, TOV = p.TOV;
    return (
      PTS + 0.4*FG - 0.7*FGA - 0.4*(FTA-FT) + 0.7*ORB + 0.3*DRB + STL +
      0.7*AST + 0.7*BLK - 0.4*PF - TOV
    );
  }

  function derive(p) {
    // clamp editable
    for (const [k] of EDITABLE) p[k] = clamp0(p[k] || 0);

    // derived core
    p.FGM = p["2PM"] + p["3PM"];
    p.FGA = p["2PA"] + p["3PA"];
    p.REB = p.OREB + p.DREB;
    p.PTS = 2*p["2PM"] + 3*p["3PM"] + p.FTM;

    // %
    p["2P%"] = pct(p["2PM"], p["2PA"]);
    p["3P%"] = pct(p["3PM"], p["3PA"]);
    p["FT%"] = pct(p.FTM, p.FTA);
    p["FG%"] = pct(p.FGM, p.FGA);
    const denom = 2 * (p.FGA + 0.44 * p.FTA);
    p["TS%"] = denom ? (p.PTS / denom) : 0;

    p.GSC = calcGSC(p);
    return p;
  }

  function newPlayer(name) {
    return derive({
      NAMES: name,
      "2PM":0,"2PA":0,"3PM":0,"3PA":0,
      FTM:0,FTA:0, OREB:0,DREB:0,
      AST:0,STL:0,BLK:0,TOV:0,FLS:0,
      // derived placeholders
      FGM:0,FGA:0,PTS:0,REB:0,
      "FG%":0,"TS%":0,"FT%":0,"2P%":0,"3P%":0,
      GSC:0
    });
  }

  let state = { players: [] };

  function showMsg(s, ok=true) {
    const el = document.getElementById("msg");
    el.style.display = "block";
    el.textContent = s;
    el.className = "msg" + (ok ? "" : " danger");
  }

  function renderHeader() {
    const head = document.getElementById("thead");
    head.innerHTML = "";

    const thName = document.createElement("div");
    thName.className = "th";
    thName.textContent = "player";
    head.appendChild(thName);

    for (const [,label] of EDITABLE) {
      const th = document.createElement("div");
      th.className = "th";
      th.textContent = label;
      head.appendChild(th);
    }

    const thRemove = document.createElement("div");
    thRemove.className = "th";
    thRemove.textContent = "";
    head.appendChild(thRemove);
  }

  function renderRows() {
    const body = document.getElementById("tbody");
    body.innerHTML = "";

    state.players.forEach((p, idx) => {
      derive(p);

      const row = document.createElement("div");
      row.className = "trow";

      const name = document.createElement("div");
      name.className = "td namecell";
      name.textContent = p.NAMES;
      row.appendChild(name);

      for (const [key,label] of EDITABLE) {
        const cell = document.createElement("div");
        cell.className = "td";

        const box = document.createElement("div");
        box.className = "statbox";
        box.onclick = (e) => {
          const delta = e.shiftKey ? -1 : 1;
          p[key] = clamp0((p[key] || 0) + delta);
          renderRows();
        };


        const l = document.createElement("div");
        l.className = "statlabel";
        l.textContent = label;

        const v = document.createElement("div");
        v.className = "statval";
        v.textContent = String(p[key] || 0);

        box.appendChild(l);
        box.appendChild(v);
        cell.appendChild(box);
        row.appendChild(cell);
      }

      const rm = document.createElement("div");
      rm.className = "td";
      const btn = document.createElement("button");
      btn.textContent = "remove";
      btn.onclick = () => {
        state.players.splice(idx, 1);
        renderRows();
      };
      rm.appendChild(btn);
      row.appendChild(rm);

      body.appendChild(row);
    });
  }

  function render() {
    renderHeader();
    renderRows();
  }

  function initPlayersDropdown() {
    const sel = document.getElementById("playerSelect");
    COMMON_PLAYERS.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });
  }

  document.getElementById("addPlayer").onclick = () => {
    const sel = document.getElementById("playerSelect");
    const picked = sel.value.trim();
    const custom = document.getElementById("customName").value.trim();
    const name = custom || picked;

    if (!name) return;

    // avoid duplicates
    const exists = state.players.some(p => p.NAMES.toLowerCase() === name.toLowerCase());
    if (exists) {
      showMsg("player already added", false);
      return;
    }

    state.players.push(newPlayer(name));
    document.getElementById("customName").value = "";
    sel.value = "";
    renderRows();
  };

  document.getElementById("save").onclick = async () => {
    const season = document.getElementById("season").value.trim();
    const game = document.getElementById("game").value.trim();
    const opp = document.getElementById("opp").value.trim();
    const type = document.getElementById("type").value;

    if (!season || !game || !opp) {
      showMsg("season/game/opp required", false);
      return;
    }
    if (!state.players.length) {
      showMsg("add at least one player", false);
      return;
    }

    const players = state.players.map(p => derive({...p}));

    const oppScore = Number(document.getElementById("oppScore").value || 0);

    const payload = {
      meta: {
        season: Number(season),
        game: Number(game),
        opp,
        type,
        oppScore   // âœ… THIS WAS MISSING
      },
      players
    };


    try {
      const res = await fetch(API + "/api/save_game", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const js = await res.json();
      if (!res.ok) throw new Error(js.error || "save failed");
      showMsg(`saved: ${js.inserted} rows`);
    } catch (err) {
      showMsg(String(err), false);
    }
  };

  initPlayersDropdown();
  render();
</script>
</body>
</html>
