<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>injury reserves - admin</title>

  <style>
    :root{
      --bg0:#0b0c10;
      --bg1:#11131a;
      --panel: rgba(10,10,14,0.62);
      --stroke: rgba(255,255,255,0.12);
      --stroke2: rgba(255,255,255,0.08);
      --text: #f2f2f2;
      --muted: rgba(242,242,242,0.75);
      --red1:#DB2E2E;
      --red2:#b50728;
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(219,46,46,0.22), transparent 60%),
        radial-gradient(1100px 520px at 90% 20%, rgba(181,7,40,0.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
    }

    .wrap{
      width: min(1200px, 94vw);
      margin: 22px auto;
      padding: 0 0 28px;
    }

    .header{
      border-radius: 22px;
      padding: 18px;
      background: rgba(15,16,22,0.55);
      border: 1px solid var(--stroke);
      box-shadow: 0 22px 70px rgba(0,0,0,0.60);
      backdrop-filter: blur(14px);
    }

    .title{
      font-size: 28px;
      font-weight: 750;
      margin: 0;
      letter-spacing: 0.2px;
    }

    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .panel{
      margin-top: 14px;
      border-radius: 22px;
      padding: 16px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      backdrop-filter: blur(14px);
    }

    .top{
      display:flex;
      gap:12px;
      flex-wrap: wrap;
      align-items:end;
    }

    .hint{
      color: var(--muted);
      font-size: 12px;
      margin: 0 0 6px;
    }

    input, select, button{
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text);
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.35);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    input:disabled{
      opacity: 0.75;
      cursor: not-allowed;
    }

    input:focus, select:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(181,7,40,0.20), 0 10px 30px rgba(0,0,0,0.35);
    }

    button{
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    button.primary{
      background: linear-gradient(180deg, rgba(219,46,46,0.95), rgba(181,7,40,0.85));
      border-color: rgba(255,255,255,0.14);
      box-shadow: 0 0 0 2px rgba(181,7,40,0.18) inset, 0 18px 44px rgba(0,0,0,0.45);
    }

    button.ghost{
      background: rgba(0,0,0,0.28);
    }


    .smallbtn{
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 800;
      line-height: 1;
    }

    .small{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.4;
    }

    .msg{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.35);
      border: 1px solid var(--stroke);
      display:none;
    }

    .msg.danger{
      border-color: rgba(255,90,90,0.40);
    }

    .table{
      margin-top: 14px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.28);
      box-shadow: 0 16px 55px rgba(0,0,0,0.55);
    }

    .thead, .trow{
      display: grid;
      grid-template-columns:
        220px
        repeat(13, 70px)
        120px; /* remove */
      align-items: center;
    }

    .thead{
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(180deg, rgba(181,7,40,0.35), rgba(0,0,0,0.85));
      border-bottom: 1px solid var(--stroke2);
      backdrop-filter: blur(10px);
    }

    .th, .td{
      padding: 12px 10px;
      border-right: 1px solid var(--stroke2);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-size: 11px;
      color: rgba(242,242,242,0.85);
      font-weight: 750;
      white-space: nowrap;
    }

    .td{
      text-transform: none;
      letter-spacing: 0;
      font-size: 14px;
      color: var(--text);
      font-weight: 650;
      border-top: 1px solid var(--stroke2);
    }

    .thead .th:last-child, .trow .td:last-child{ border-right: none; }

    .trow:hover .td{
      filter: brightness(1.06);
    }

   .trow{
  position: relative;
}

/* race stripe */


/* keep content above the stripe */
.trow > .td{
  position: relative;
  z-index: 1;
}


    .trow::before{
      content:"";
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:6px;
      background: var(--rowcolor, transparent);
      border-radius: 6px 0 0 6px;
      pointer-events: none;
    }

    .trow::after{
  content: "";
  position: absolute;
  inset: 0;
  background: var(--rowcolor);
  opacity: 0.18;          /* strength of stripe */
  pointer-events: none;
  z-index: 0;
}

    .trow.hasColor{
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(0,0,0,0.0));
    }

    .namecell{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .chip{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      box-shadow: 0 10px 22px rgba(0,0,0,0.45);
      flex: 0 0 auto;
    }

    .statbox{
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 8px 8px;
      user-select: none;
      cursor: pointer;
      text-align: center;
      background: rgba(0,0,0,0.25);
    }

    .statlabel{
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      font-weight: 800;
    }

    .statval{
      font-size: 16px;
      font-weight: 850;
      line-height: 1.1;
    }

    .removeBtn{
      width: 100%;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(0,0,0,0.30);
    }

    @media (max-width: 1100px){
      .table{ overflow-x: auto; }
      .thead, .trow{ min-width: 1250px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <h1 class="title">admin game entry</h1>
      <div class="subtitle">click a stat to +1. shift+click to -1. derived stats auto-calc on save.</div>
    </div>

    <div class="panel">
      <div class="top">
        <div>
          <div class="hint">season</div>
          <input id="season" value="4" />
        </div>

        <div>
          <div class="hint">game</div>
          <input id="game" value="1" />
        </div>

        <div style="min-width: 220px;">
          <div class="hint">opp</div>
          <input id="opp" placeholder="OPP" />
        </div>

        <div>
          <div class="hint">opp colour</div>
          <input id="oppColor" type="color" value="#4B5563" />
<div style="min-width: 170px;">
  <div class="hint">period</div>
  <select id="period" style="min-width: 170px;">
    <option value="1ST">1ST</option>
    <option value="2ND">2ND</option>
    <option value="3RD">3RD</option>
    <option value="4TH">4TH</option>
    <option value="OT">OT</option>
  </select>
</div>
        </div>

        <div>
          <div class="hint">type</div>
          <select id="type">
            <option value="REG">REG</option>
            <option value="PRE">PRE</option>
            <option value="FINAL">FINAL</option>
          </select>
        </div>
<div>
          <div class="hint">opp score</div>
          <input id="oppScore" value="0" />
          <div class="btnrow" style="display:flex; gap:8px; margin-top:8px;">
            <button class="ghost smallbtn" data-oppdelta="-1">-1</button>
            <button class="ghost smallbtn" data-oppdelta="1">+1</button>
            <button class="ghost smallbtn" data-oppdelta="2">+2</button>
            <button class="ghost smallbtn" data-oppdelta="3">+3</button>
          </div>
        </div>

        <div style="min-width: 260px;">
          <div class="hint">add player</div>
          <select id="playerSelect" style="min-width: 260px;">
            <option value="">select player...</option>
          </select>
        </div>

        <div style="min-width: 220px;">
          <div class="hint">or custom name</div>
          <input id="customName" placeholder="new player name" />
        </div>

        <button id="addPlayer" class="ghost">add</button>
        <button id="save" class="primary">save game</button>
      </div>

      <div class="small">
        click a stat to +1. shift+click to -1. fgm/fga/pts/reb/%/gsc are calculated automatically.
      </div>

      <div id="msg" class="msg"></div>

      <div class="table" id="table">
        <div class="thead" id="thead"></div>
        <div id="tbody"></div>
      </div>
    </div>
  </div>

<script>
  const API = "http://127.0.0.1:5001";

  const COMMON_PLAYERS = [
    "Daniel Monitto",
    "Lachlan Farley",
    "James Norrish",
    "Vince Tomasello",
    "Austin Thorneycroft",
    "Brooklyn Bulmer"
  ];

  // only common names
  const COLOR_MAP = {
    "Brooklyn Bulmer": "#5f99f5",
    "Daniel Monitto": "#ebc026",
    "Lachlan Farley": "#59dea2",
    "James Norrish": "#fc9219",
    "Vince Tomasello": "#63b010",
    "Austin Thorneycroft": "#8858e8",
  };

  function pushLiveScore() {
  let team = 0;
  state.players.forEach(p => team += p.PTS || 0);

  const opp = Number(document.getElementById("oppScore").value || 0);
  const period = document.getElementById("period").value;

  fetch(API + "/api/live_score", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      home: team,
      away: opp,
      opp: document.getElementById("opp").value || "OPP",
      oppColor: document.getElementById("oppColor").value || "#4B5563",
      period: period
    })
  });
}




  const EDITABLE = [
    ["2PM","2pm"], ["2PA","2pa"], ["3PM","3pm"], ["3PA","3pa"],
    ["FTM","ftm"], ["FTA","fta"],
    ["OREB","oreb"], ["DREB","dreb"],
    ["AST","ast"], ["STL","stl"], ["BLK","blk"],
    ["TOV","tov"], ["FLS","fls"]
  ];

  const clamp0 = (n) => Math.max(0, n|0);

  function pct(m, a) { return a ? (m / a) : 0; }

  function calcGSC(p) {
    const PTS = p.PTS, FG = p.FGM, FGA = p.FGA, FT = p.FTM, FTA = p.FTA;
    const ORB = p.OREB, DRB = p.DREB, STL = p.STL, AST = p.AST, BLK = p.BLK;
    const PF = p.FLS, TOV = p.TOV;
    return (
      PTS + 0.4*FG - 0.7*FGA - 0.4*(FTA-FT) + 0.7*ORB + 0.3*DRB + STL +
      0.7*AST + 0.7*BLK - 0.4*PF - TOV
    );
  }

  function derive(p) {
    for (const [k] of EDITABLE) p[k] = clamp0(p[k] || 0);

    p.FGM = p["2PM"] + p["3PM"];
    p.FGA = p["2PA"] + p["3PA"];
    p.REB = p.OREB + p.DREB;
    p.PTS = 2*p["2PM"] + 3*p["3PM"] + p.FTM;

    p["2P%"] = pct(p["2PM"], p["2PA"]);
    p["3P%"] = pct(p["3PM"], p["3PA"]);
    p["FT%"] = pct(p.FTM, p.FTA);
    p["FG%"] = pct(p.FGM, p.FGA);
    const denom = 2 * (p.FGA + 0.44 * p.FTA);
    p["TS%"] = denom ? (p.PTS / denom) : 0;

    p.GSC = calcGSC(p);
    return p;
  }

  function newPlayer(name) {
    return derive({
      NAMES: name,
      "2PM":0,"2PA":0,"3PM":0,"3PA":0,
      FTM:0,FTA:0, OREB:0,DREB:0,
      AST:0,STL:0,BLK:0,TOV:0,FLS:0,
      FGM:0,FGA:0,PTS:0,REB:0,
      "FG%":0,"TS%":0,"FT%":0,"2P%":0,"3P%":0,
      GSC:0
    });
  }

  let state = { players: [] };

  function showMsg(s, ok=true) {
    const el = document.getElementById("msg");
    el.style.display = "block";
    el.textContent = s;
    el.className = "msg" + (ok ? "" : " danger");
  }

  function renderHeader() {
    const head = document.getElementById("thead");
    head.innerHTML = "";

    const thName = document.createElement("div");
    thName.className = "th";
    thName.textContent = "player";
    head.appendChild(thName);

    for (const [,label] of EDITABLE) {
      const th = document.createElement("div");
      th.className = "th";
      th.textContent = label;
      head.appendChild(th);
    }

    const thRemove = document.createElement("div");
    thRemove.className = "th";
    thRemove.textContent = "";
    head.appendChild(thRemove);
  }

  function renderRows() {
    const body = document.getElementById("tbody");
    body.innerHTML = "";

    state.players.forEach((p, idx) => {
      derive(p);

      const row = document.createElement("div");
      row.className = "trow";

      // name cell with color chip + row strip (only for mapped names)
      const name = document.createElement("div");
      name.className = "td namecell";

      const chip = document.createElement("div");
      chip.className = "chip";

      const c = COLOR_MAP[p.NAMES];
      if (c) row.style.setProperty("--rowcolor", c);
      if (c) {
        row.classList.add("hasColor");
        row.style.setProperty("--rowcolor", c);
        row.style.borderLeft = "6px solid " + c;
        row.style.background = "linear-gradient(90deg, " + c + "22 0%, rgba(0,0,0,0) 22%)";
        chip.style.background = c;
      } else {
        chip.style.background = "rgba(255,255,255,0.25)";
        chip.style.opacity = "0.8";
      }

      const label = document.createElement("div");
      label.textContent = p.NAMES;

      name.appendChild(chip);
      name.appendChild(label);
      row.appendChild(name);

      for (const [key,labelTxt] of EDITABLE) {
        const cell = document.createElement("div");
        cell.className = "td";

        const box = document.createElement("div");
        box.className = "statbox";
        box.onclick = (e) => {
            const delta = e.shiftKey ? -1 : 1;
            p[key] = clamp0((p[key] || 0) + delta);
            renderRows();
            pushLiveScore();
        };


        const l = document.createElement("div");
        l.className = "statlabel";
        l.textContent = labelTxt;

        const v = document.createElement("div");
        v.className = "statval";
        v.textContent = String(p[key] || 0);

        box.appendChild(l);
        box.appendChild(v);
        cell.appendChild(box);
        row.appendChild(cell);
      }

      const rm = document.createElement("div");
      rm.className = "td";
      const btn = document.createElement("button");
      btn.className = "removeBtn";
      btn.textContent = "remove";
      btn.onclick = () => {
        state.players.splice(idx, 1);
        renderRows();
        pushLiveScore();
      };

      rm.appendChild(btn);
      row.appendChild(rm);

      body.appendChild(row);
    });
  }



  function render() {
    renderHeader();
    renderRows();
  }

  function initPlayersDropdown() {
    const sel = document.getElementById("playerSelect");
    COMMON_PLAYERS.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });
  }

  document.getElementById("addPlayer").onclick = () => {
    const sel = document.getElementById("playerSelect");
    const picked = sel.value.trim();
    const custom = document.getElementById("customName").value.trim();
    const name = custom || picked;

    if (!name) return;

    const exists = state.players.some(p => p.NAMES.toLowerCase() === name.toLowerCase());
    if (exists) {
      showMsg("player already added", false);
      return;
    }

    state.players.push(newPlayer(name));
    document.getElementById("customName").value = "";
    sel.value = "";
    renderRows();
    pushLiveScore();
  };

  document.getElementById("save").onclick = async () => {
    const season = document.getElementById("season").value.trim();
    const game = document.getElementById("game").value.trim();
    const opp = document.getElementById("opp").value.trim();
    const type = document.getElementById("type").value;

    if (!season || !game || !opp) {
      showMsg("season/game/opp required", false);
      return;
    }
    if (!state.players.length) {
      showMsg("add at least one player", false);
      return;
    }

    const players = state.players.map(p => derive({...p}));
    const oppScore = Number(document.getElementById("oppScore").value || 0);

    const payload = {
      meta: {
        season: Number(season),
        game: Number(game),
        opp,
        type,
        oppScore,
        oppColor: document.getElementById("oppColor").value || ""
      },
      players
    };

    try {
      const res = await fetch(API + "/api/save_game", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const js = await res.json();
      if (!res.ok) throw new Error(js.error || "save failed");
      showMsg(`saved: ${js.inserted} rows`);
    } catch (err) {
      showMsg(String(err), false);
    }
  };

  initPlayersDropdown();
  render();
  document.getElementById("oppScore").addEventListener("input", pushLiveScore);
  document.getElementById("opp").addEventListener("input", pushLiveScore);
  document.getElementById("oppColor").addEventListener("input", pushLiveScore);
  document.getElementById("period").addEventListener("change", pushLiveScore);

  // quick +/- buttons for opp score (1/2/3)
  document.querySelectorAll("[data-oppdelta]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const d = Number(btn.getAttribute("data-oppdelta") || 0);
      const inp = document.getElementById("oppScore");
      const cur = Number(inp.value || 0);
      inp.value = String(Math.max(0, cur + d));
      pushLiveScore();
    });
  });

</script>
</body>
</html>
