<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">

  <style>
    :root{
      --inj: #DB2E2E;
      --opp: #4B5563;

      /* stripe colors (set from API) */
      --injStripe1: rgba(255,255,255,0.95); /* white */
      --injStripe2: rgba(181,7,40,0.95);    /* red */
      --oppStripe1: rgba(255,255,255,0.85);
      --oppStripe2: rgba(255,255,255,0.25);

      --fg: #ffffff;
      --stroke: rgba(255,255,255,0.18);
      --shadow: 0 22px 70px rgba(0,0,0,0.65);

      --period-bg: #0e0f12;
      --period-stroke: rgba(255,255,255,0.16);

      /* stripe geometry */
      --stripe-w: 170px;
      --stripe-h: 8px;
      --stripe-gap: 5px;
      --stripe-tilt: -50deg; /* towards abbreviation */
      --stripe-shadow: 0 6px 16px rgba(0,0,0,0.28);
    }

    html, body{
      width: 750px;
      height: 110px;
      margin:0;
      padding:0;
      background: transparent;
      overflow: hidden;
      font-family: "Russo One", system-ui, sans-serif;
    }

    .bar{
  width: 750px;
  height: 70px;           /* scoreboard stays 70px */
  display:flex;
  align-items:stretch;
  overflow:hidden;
  border-radius: 0;
  border: 2px solid var(--stroke);
      border-color: silver;

  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;              /* locks it to the bottom */
}


    .team{
      flex: 1 1 0;
      min-width: 240px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
      color: var(--fg);
      position: relative;
      isolation: isolate;
    }

    .team.inj{ background: var(--inj); }
    .team.opp{
      background: var(--opp);
      border-left: 2px solid rgba(255,255,255,0.22);
    }

    /* left vertical stripe */
    .team::before{
      content:"";
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width: 1px;
      background: rgba(255,255,255,0.30);
      z-index: 0;
    }

    /* subtle dots */
    .team::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(rgba(255,255,255,0.18) 1px, transparent 1px);
      background-size: 18px 18px;
      opacity: 0.14;
      pointer-events:none;
      z-index: 0;
    }

    /* === double middle stripes (2 bars) === */
    .midstripes{
      position:absolute;
      top: 50%;
      left: 100px;
      transform: translate(-50%, -50%) rotate(var(--stripe-tilt));
      width: var(--stripe-w);
      height: calc(var(--stripe-h) * 2 + var(--stripe-gap));
      z-index: 1;
      pointer-events:none;
    }

    /* inj side: anchored left, points toward abbr */
    .team.inj .midstripes{ left: 170px; }

    /* opp side: anchored right, still points toward its abbr */
/* opp side: anchored right, flip it */
    .team.opp .midstripes{
      left: auto;
      right: 170px; /* adjust if you want closer/further from abbr */
      top: 50%;
      transform: translate(50%, 50%) rotate(calc(var(--stripe-tilt)));
    }

    .midstripes::before{
      content: "";
      position: absolute;
      inset: -3px;                 /* thickness of black backing */
      background: #000;            /* solid black */
      z-index: -1;
    }



    .midbar{
      height: var(--stripe-h);
      border-radius: 999px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.18);
    }

    .midbar + .midbar{ margin-top: var(--stripe-gap); }

    /* colors per side */
    .team.inj .midbar.one{ background: var(--injStripe1); }
    .team.inj .midbar.two{ background: var(--injStripe2); }

    .team.opp .midbar.one{ background: var(--oppStripe1); }
    .team.opp .midbar.two{ background: var(--oppStripe2); }

    .left{
      display:flex;
      align-items:center;
      gap: 12px;
      position: relative;
      z-index: 2;
    }

    .abbr{
      font-size: 40px;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 0 8px 20px rgba(0,0,0,0.45);
    }

    .pts{
      position: relative;
      z-index: 2;
      font-size: 60px;
      line-height: 1;
      letter-spacing: -1.5px;
      min-width: 76px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      text-shadow:
        0 10px 24px rgba(0,0,0,0.45),
        0 0 22px rgba(255,255,255,0.18);
    }

    .period{
      width: 96px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: var(--period-bg);
      color: #fff;
      font-size: 20px;
      letter-spacing: 2px;
      text-transform: uppercase;
      border-left: 2px solid var(--period-stroke);
      text-shadow: 0 6px 18px rgba(0,0,0,0.55);
    }

.toast{
  position: absolute;
  left: 10px;

  transform: translateY(14px);

  bottom: 70px;          /* sits above the 70px bar */
  margin-bottom: 6px;

  display: inline-flex;
  align-items: center;
  gap: 10px;

  padding: 6px 14px;
  height: auto;          /* fit content */
  width: max-content;    /* fit text */
  max-width: 720px;      /* safety */

  background: rgba(0,0,0,0.88);
  border: 2px solid rgba(255,255,255,0.18);


  overflow: hidden;
  pointer-events: none;

  opacity: 0;
  transition:
    transform 160ms cubic-bezier(.2,.9,.2,1),
    opacity 160ms ease;
  z-index: 100;
}

.toast.show{
  transform: translateY(0);
  opacity: 1;
}

.toast,
.toast .title,
.toast .line{
  color: #ffffff;
}


.toast .t{
  display:flex;
  align-items:baseline;
  gap:10px;
  white-space: nowrap;
  overflow: hidden;
}

.toast .title{
  font-size: 18px;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.toast .line{
  font-size: 18px;
  letter-spacing: 1px;
  color: rgba(255,255,255,0.92);
}


*{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  </style>
</head>

<body>
  <div class="bar" id="bar">
    <div class="team inj">
      <div class="midstripes">
        <div class="midbar one"></div>
        <div class="midbar two"></div>
      </div>

      <div class="left">
      <div class="abbr">inj</div>
    </div>

      <div class="pts" id="home">0</div>
    </div>

    <div class="team opp">
      <div class="midstripes">
        <div class="midbar one"></div>
        <div class="midbar two"></div>
      </div>

      <div class="left">
        <div class="abbr" id="oppAbbr">opp</div>
      </div>
      <div class="pts" id="away">0</div>
    </div>

    <div class="period" id="period">1st</div>
  </div>

  <div class="toast" id="toast">
  <div class="accent" id="toastAccent"></div>
  <div class="t">
    <div class="title" id="toastTitle">player</div>
    <div class="line" id="toastLine">10 points</div>
  </div>
</div>


<script>
let lastEventSeq = 0;
let toastTimer = null;
let prevHome = null;
let prevAway = null;
let pulseTimer = null;

function pulseBar(){
  const bar = document.getElementById('bar');
  if(!bar) return;
  bar.classList.remove('pulse');
  // force reflow so animation retriggers
  void bar.offsetWidth;
  bar.classList.add('pulse');
  if(pulseTimer) clearTimeout(pulseTimer);
  pulseTimer = setTimeout(()=>bar.classList.remove('pulse'), 450);
}


function showToast(ev){
  const toast = document.getElementById("toast");
  const title = document.getElementById("toastTitle");
  const line  = document.getElementById("toastLine");

  const color = (ev && ev.color) ? ev.color : "#DB2E2E";
  document.documentElement.style.setProperty("--toastColor", color);

  title.textContent = (ev.title || "").toString();
  line.textContent  = (ev.line  || "").toString();

  toast.classList.add("show");
  pulseBar();
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove("show"), Number(ev.ttlMs || 2500));
}

async function poll(){
  // scores + colors (existing)
  const r = await fetch("/api/scoreboard", { cache: "no-store" });
  if(!r.ok) return;
  const j = await r.json();

  const homeVal = j.home ?? 0;
  const awayVal = j.away ?? 0;

  document.getElementById("home").textContent = homeVal;
  document.getElementById("away").textContent = awayVal;

  if (prevHome === null) { prevHome = homeVal; prevAway = awayVal; }
  if (homeVal !== prevHome || awayVal !== prevAway){
    prevHome = homeVal; prevAway = awayVal;
    pulseBar();
  }

  const opp = (j.opp || "opp").toString().trim();

// keep full name in admin, show 3-letter abbr on scoreboard
const abbr = opp
  .replace(/[^a-zA-Z]/g, "")   // remove spaces/symbols/numbers
  .slice(0, 3)                 // first 3 letters
  .toUpperCase();              // scoreboard style

document.getElementById("oppAbbr").textContent = abbr || "OPP";


  document.documentElement.style.setProperty("--inj", j.injColor || "#DB2E2E");
  document.documentElement.style.setProperty("--opp", j.oppColor || "#4B5563");

  if (j.injStripe1) document.documentElement.style.setProperty("--injStripe1", j.injStripe1);
  if (j.injStripe2) document.documentElement.style.setProperty("--injStripe2", j.injStripe2);
  if (j.oppStripe1) document.documentElement.style.setProperty("--oppStripe1", j.oppStripe1);
  if (j.oppStripe2) document.documentElement.style.setProperty("--oppStripe2", j.oppStripe2);

  if (j.stripeGap !== undefined && j.stripeGap !== null){
    const g = Number(j.stripeGap);
    if (!Number.isNaN(g)) document.documentElement.style.setProperty("--stripe-gap", `${Math.max(0, g)}px`);
  }
  if (j.stripeShadowAlpha !== undefined && j.stripeShadowAlpha !== null){
    const a = Number(j.stripeShadowAlpha);
    if (!Number.isNaN(a)) document.documentElement.style.setProperty("--stripe-shadow", `0 6px 16px rgba(0,0,0,${Math.max(0, Math.min(1, a))})`);
  }
  if (j.strokeAlpha !== undefined && j.strokeAlpha !== null){
    const a = Number(j.strokeAlpha);
    if (!Number.isNaN(a)) document.documentElement.style.setProperty("--stroke", `rgba(255,255,255,${Math.max(0, Math.min(1, a))})`);
  }


  document.getElementById("period").textContent =
    (j.period || "1st").toString().toLowerCase();

  // NEW: popup event polling
  try{
    const er = await fetch("/api/overlay_event", { cache: "no-store" });
    if (er.ok){
      const ej = await er.json();
      const seq = Number(ej.seq || 0);
      if (seq > lastEventSeq && ej.event){
        lastEventSeq = seq;
        showToast(ej.event);
      }
    }
  }catch(_){}
}

setInterval(poll, 250);
poll();
</script>

</body>
</html>
